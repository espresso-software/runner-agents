# This is a basic workflow to help you get started with Actions

name: Swarm Deploy Agent Bootstrap
permissions:
  contents: read
  pull-requests: read
  issues: write

# Controls when the workflow will run
on:
  workflow_dispatch:
  push:
    branches-ignore:
      - main
    paths:
      - ansible/**
      - .github/workflows/bootstrap-deploy.yml
env:
  DOCKER_REPOSITORY: coffee206/github-actions
  GITHUB_ACTIONS_VERSION: "2.330.0"

jobs:
  base-versioning:
    runs-on:
      - self-hosted
      - swarm
    outputs:
      x64_tag: x64-${{ env.IMAGE_VERSION }}

    steps:
      - uses: actions/checkout@v2
      - uses: espresso-software/actions/common/versioning@main
        id: get_version
        with:
          version_file: ubi-agent/version.json

  base-build:
    needs:
      - base-versioning
    runs-on:
      - self-hosted
      - deploy-ansible
      - x64
    env:
      TARGETARCH: linux-x64
    steps:
      - uses: actions/checkout@v2

      - name: Build and publish image
        uses: ./.github/actions/ubi-agent-build
        env:
          DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PAT }}
        with:
          actions_version: ${{ env.GITHUB_ACTIONS_VERSION }}
          targetarch: ${{ env.TARGETARCH }}
          build_directory: ubi-agent
          tag: ${{ needs.base-versioning.outputs.x64_tag }}.BOOTSTRAP

  ansible-versioning:
    runs-on:
      - self-hosted
      - deploy-ansible
    outputs:
      x64_tag: x64-ansible-${{ env.IMAGE_VERSION }}
    steps:
      - uses: actions/checkout@v2
      - uses: espresso-software/actions/common/versioning@main
        id: get_version
        with:
          version_file: ansible/version.json

  ansible-build:
    needs:
      - base-versioning
      - base-build
      - ansible-versioning
    runs-on:
      - self-hosted
      - deploy-ansible
      - x64
    env:
      TARGETARCH: linux-x64
      BUILD_DIR: ansible
    steps:
      - uses: actions/checkout@v2

      - name: Build and publish image
        uses: espresso-software/actions/docker/build-and-push@main
        with:
          repository: ${{ env.DOCKER_REPOSITORY }}
          tag: ${{ needs.deploy-versioning.outputs.x64_tag }}.BOOTSTRAP
          build_dir: ${{ env.BUILD_DIR }}
          build_args: --build-arg TAG=${{ needs.base-versioning.outputs.x64_tag }}.BOOTSTRAP
        env:
          DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PAT }}

  # TODO: Deploy to Swarm cluster
